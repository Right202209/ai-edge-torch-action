name: AI Edge Torch Conversion

# 触发条件：当你 push 代码到 main 分支，或者手动点击触发
on:
  push:
    branches: [ "main" ]
    paths:
      - '*.pth'        # 只有当模型权重文件更新时才触发
      - 'torch_to_tflite_direct.py' # 或者转换脚本更新时
      - '.github/workflows/**'
  workflow_dispatch:          # 允许在 GitHub 网页上手动点击按钮运行

jobs:
  convert-to-tflite:
    runs-on: ubuntu-latest    # 关键点：使用 Linux 环境，完美避开 Windows 兼容性问题

    steps:
      # 1. 拉取代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. 设置 Python 环境 (推荐 3.10)
      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          # cache: 'pip' # 开启缓存，加速后续构建

      # 3. 安装依赖 (云端环境是干净的，不会有冲突)
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # 安装 PyTorch CPU 版本以节省时间（转换不需要 GPU）
          pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu
          # 安装 ai-edge-torch
          pip install ai-edge-torch

      # 4. 创建输出目录 (防止脚本报错)
      - name: Create Output Directory
        run: mkdir -p models

      # 5. 执行转换脚本
      - name: Run Conversion Script
        run: python torch_to_tflite_direct.py

      # 6. 上传生成的 TFLite 模型作为构件 (Artifact)
      - name: Upload TFLite Model
        uses: actions/upload-artifact@v4
        with:
          name: crop-disease-tflite
          path: models/*.tflite
          retention-days: 5
